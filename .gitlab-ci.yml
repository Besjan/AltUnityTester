stages:
  - build-android
  - android-tests
  - build-ios
  - ios-tests
  - appium-tests
  - deploy
  

build-ipa:
    stage: build-ios
    tags:
      - unity
    script:
      - /Applications/Unity/Unity.app/Contents/MacOS/Unity -projectPath $CI_PROJECT_DIR -executeMethod AltUnityTesterEditor.InitEditorConfiguration -logFile initEditorConfiguration.log -quit
      - /Applications/Unity/Unity.app/Contents/MacOS/Unity -projectPath $CI_PROJECT_DIR -executeMethod AltUnityTesterEditor.IosBuildFromCommandLine -logFile buildIos.log -quit
      - cd sampleGame
      - xcodebuild build-for-testing -scheme Unity-iPhone -destination generic/platform=iOS
      - ls 
    artifacts:
      when: always
      expire_in: 10 days
      paths:
        - buildIos.log

run-csharp-ios-tests:
    stage: ios-tests
    tags:
        - unity
    script:
        - xcodebuild test-without-building -destination 'platform=iOS,name=iPhone' &
        - sleep 60
        - /Applications/Unity/Unity.app/Contents/MacOS/Unity -projectPath $CI_PROJECT_DIR -executeMethod AltUnityTesterEditor.RunAllTestsIOS -logFile csharpIosTests.log -quit        
    artifacts:
      when: always
      expire_in: 10 days
      paths:
        - csharpIosTests.log    
 
        
run-python-appium-android-tests:
    stage: appium-tests
    only:
        refs:
            - master
    tags:
        - unity
    script:
        - virtualenv altunitytests
        - source altunitytests/bin/activate
        # - killall node || true
        # - appium >> appium.log & 
        - pip install Appium-Python-Client
        - pip uninstall --yes altunityrunner || true
        - pip install -e Assets/AltUnityTester/Bindings/python
        - sleep 30
        - python Assets/AltUnityTester/Bindings/python_appium_tests.py
        # - killall node || true
    artifacts:
        when: always
        expire_in: 10 days
        paths:
            - appium.log

run-java-appium-android-tests:
    stage: appium-tests
    only:
        refs:
            - master
    tags:
        - unity
    script:
        - cd Assets/AltUnityTester/Bindings/java
        - mvn clean compile assembly:single
        - mvn install:install-file -Dfile=./target/altunitytester-java-client-1.0-SNAPSHOT-jar-with-dependencies.jar -DgroupId=ro.altom -DartifactId=altunitytester -Dversion=1.0 -Dpackaging=jar
        - cd ../java-appium-tests
        - mvn test
    artifacts:
        when: always
        expire_in: 10 days
        paths:
            - ./Assets/AltUnityTester/Bindings/java/target/altunitytester-java-client-1.0-SNAPSHOT-jar-with-dependencies.jar

deploy-altunitytester-python:
    stage: deploy
    when: manual
    only:
        refs:
            - master
    tags:
        - unity
    script:
        - cd Assets/AltUnityTester/Bindings/python
        - python setup.py sdist upload -r pypi